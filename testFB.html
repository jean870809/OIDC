<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <fb:login-button data-auto-logout-link="true" scope="public_profile,email" size="large"></fb:login-button>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.21.0/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.21.0/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.21.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.21.0/firebase-firestore.js"></script>


    <!-- TODO: Add SDKs for Firebase products that you want to use
    https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.21.0/firebase-analytics.js"></script>

    <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        var firebaseConfig = {
            apiKey: "AIzaSyBf2umL61BkqJufaBGKvwZsmd0wpLrmQAE",
            authDomain: "test-f3031.firebaseapp.com",
            databaseURL: "https://test-f3031.firebaseio.com",
            projectId: "test-f3031",
            storageBucket: "test-f3031.appspot.com",
            messagingSenderId: "763216745915",
            appId: "1:763216745915:web:8575892908486e73de609e",
            measurementId: "G-XNKKBEFSTR"
        };
        // Initialize Firebase
        //firebase.initializeApp(firebaseConfig);
        var a = firebase.initializeApp(firebaseConfig);
        console.log(a)
        firebase.analytics();
    </script>


    <script>
        var provider = new firebase.auth.FacebookAuthProvider()

        // Step 1.
        // User tries to sign in to Facebook.
        auth.signInWithPopup(new firebase.auth.FacebookAuthProvider()).catch(function (error) {
            // An error happened.
            if (error.code === 'auth/account-exists-with-different-credential') {
                // Step 2.
                // User's email already exists.
                // The pending Facebook credential.
                var pendingCred = error.credential;
                // The provider account's email address.
                var email = error.email;
                // Get sign-in methods for this email.
                auth.fetchSignInMethodsForEmail(email).then(function (methods) {
                    // Step 3.
                    // If the user has several sign-in methods,
                    // the first method in the list will be the "recommended" method to use.
                    if (methods[0] === 'password') {
                        // Asks the user their password.
                        // In real scenario, you should handle this asynchronously.
                        var password = promptUserForPassword(); // TODO: implement promptUserForPassword.
                        auth.signInWithEmailAndPassword(email, password).then(function (user) {
                            // Step 4a.
                            return user.linkWithCredential(pendingCred);
                        }).then(function () {
                            // Facebook account successfully linked to the existing Firebase user.
                            goToApp();
                        });
                        return;
                    }
                    // All the other cases are external providers.
                    // Construct provider object for that provider.
                    // TODO: implement getProviderForProviderId.
                    var provider = getProviderForProviderId(methods[0]);
                    // At this point, you should let the user know that they already has an account
                    // but with a different provider, and let them validate the fact they want to
                    // sign in with this provider.
                    // Sign in to provider. Note: browsers usually block popup triggered asynchronously,
                    // so in real scenario you should ask the user to click on a "continue" button
                    // that will trigger the signInWithPopup.
                    auth.signInWithPopup(provider).then(function (result) {
                        // Remember that the user may have signed in with an account that has a different email
                        // address than the first one. This can happen as Firebase doesn't control the provider's
                        // sign in flow and the user is free to login using whichever account they own.
                        // Step 4b.
                        // Link to Facebook credential.
                        // As we have access to the pending credential, we can directly call the link method.
                        result.user.linkAndRetrieveDataWithCredential(pendingCred).then(function (usercred) {
                            // Facebook account successfully linked to the existing Firebase user.
                            goToApp();
                        });
                    });
                });
            }
        });


    </script>

    <script src="//connect.facebook.net/en_US/sdk.js"></script>
    <script>
        FB.init({
            appId: '633575047536520',
            status: true,
            xfbml: true,
            version: 'v8.0'
        });
        FB.Event.subscribe('auth.authResponseChange', checkLoginState);
        function checkLoginState(event) {
            if (event.authResponse) {
                // User is signed-in Facebook.
                var unsubscribe = firebase.auth().onAuthStateChanged(function (firebaseUser) {
                    unsubscribe();
                    // Check if we are already signed-in Firebase with the correct user.
                    if (!isUserEqual(event.authResponse, firebaseUser)) {
                        // Build Firebase credential with the Facebook auth token.
                        var credential = firebase.auth.FacebookAuthProvider.credential(
                            event.authResponse.accessToken);
                        // Sign in with the credential from the Facebook user.
                        firebase.auth().signInWithCredential(credential).catch(function (error) {
                            // Handle Errors here.
                            var errorCode = error.code;
                            var errorMessage = error.message;
                            // The email of the user's account used.
                            var email = error.email;
                            // The firebase.auth.AuthCredential type that was used.
                            var credential = error.credential;
                            // ...
                        });
                    } else {
                        // User is already signed-in Firebase with the correct user.
                    }
                });
            } else {
                // User is signed-out of Facebook.
                firebase.auth().signOut();
            }
        }
        function isUserEqual(facebookAuthResponse, firebaseUser) {
            if (firebaseUser) {
                var providerData = firebaseUser.providerData;
                for (var i = 0; i < providerData.length; i++) {
                    if (providerData[i].providerId === firebase.auth.FacebookAuthProvider.PROVIDER_ID &&
                        providerData[i].uid === facebookAuthResponse.userID) {
                        // We don't need to re-auth the Firebase connection.
                        return true;
                    }
                }
            }
            return false;
        }
    </script>
</body>

</html>